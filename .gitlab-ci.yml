# GitLab CI/CD Pipeline for Ollama Service
# This pipeline builds and pushes the Docker image to GitLab Container Registry

stages:
  - build
  - test
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # Define image name using GitLab built-in variables
  DOCKER_IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  DOCKER_LATEST_IMAGE: $CI_REGISTRY_IMAGE:latest

# Define Docker build and push before_script
.docker_before_script: &docker_before_script
  - echo "Logging in to GitLab Container Registry..."
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

# Build Docker image
build_image:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - *docker_before_script
  script: |
    echo "Building Docker image..."
    # Add retry logic for docker build
    for i in {1..3}; do
      if docker build --network=host -t $DOCKER_IMAGE_NAME .; then
        break
      else
        echo "Build attempt $i failed, retrying in 10 seconds..."
        sleep 10
      fi
    done
    echo "Built image: $DOCKER_IMAGE_NAME"
    # Add retry logic for docker push
    for i in {1..3}; do
      if docker push $DOCKER_IMAGE_NAME; then
        break
      else
        echo "Push attempt $i failed, retrying in 10 seconds..."
        sleep 10
      fi
    done
    echo "Pushed image: $DOCKER_IMAGE_NAME"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - .gitlab-ci.yml
        - Dockerfile
        - docker-compose.yml
        - "*.sh"
        - "*.py"
        - requirements.txt
  timeout: 10m

# Tag latest image
tag_latest:
  stage: release
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - *docker_before_script
  script: |
    echo "Pulling built image..."
    for i in {1..3}; do
      if docker pull $DOCKER_IMAGE_NAME; then
        break
      else
        echo "Pull attempt $i failed, retrying in 10 seconds..."
        sleep 10
      fi
    done
    echo "Tagging as latest..."
    docker tag $DOCKER_IMAGE_NAME $DOCKER_LATEST_IMAGE
    echo "Pushing latest tag..."
    for i in {1..3}; do
      if docker push $DOCKER_LATEST_IMAGE; then
        break
      else
        echo "Push attempt $i failed, retrying in 10 seconds..."
        sleep 10
      fi
    done
    echo "Latest image updated: $DOCKER_LATEST_IMAGE"
  dependencies:
    - build_image
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - .gitlab-ci.yml
        - Dockerfile
        - docker-compose.yml
        - "*.sh"
        - "*.py"
        - requirements.txt
  timeout: 20m

# Test Ollama service
test_service:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - *docker_before_script
    - |
      for i in {1..3}; do
        if docker pull $DOCKER_IMAGE_NAME; then
          break
        else
          echo "Pull attempt $i failed, retrying in 10 seconds..."
          sleep 10
        fi
      done
  script: |
    echo "Starting Ollama service for testing..."
    docker run -d --name ollama-test -p 11434:11434 $DOCKER_IMAGE_NAME
    sleep 10  # Brief initial wait
    # Check if container is still running
    if ! docker ps | grep ollama-test; then
      echo "Container stopped prematurely, checking logs..."
      docker logs ollama-test || echo "No logs available"
      exit 1
    fi
    # Wait for the service to be ready
    echo "Waiting for Ollama API to be available..."
    for i in {1..30}; do
      if docker exec ollama-test curl -f http://localhost:11434/api/tags > /dev/null 2>&1; then
        echo "Ollama API is ready!"
        break
      else
        echo "Attempt $i/30: Ollama API not ready, waiting..."
        sleep 10
        if ! docker ps | grep ollama-test > /dev/null 2>&1; then
          echo "Container stopped during wait, checking logs..."
          docker logs ollama-test || echo "No logs available"
          exit 1
        fi
      fi
    done
    echo "Checking if Ollama API is available..."
    docker exec ollama-test curl -f http://localhost:11434/api/tags
    echo "Testing model availability..."
    docker exec ollama-test ollama list
    docker exec ollama-test ollama list | grep qwen3:1.7b
    docker stop ollama-test
    docker rm ollama-test
    echo "Ollama service test completed successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - .gitlab-ci.yml
        - Dockerfile
        - docker-compose.yml
        - "*.sh"
        - "*.py"
        - requirements.txt
  timeout: 20m

# Create preview environment for merge requests
preview:
  stage: release
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - *docker_before_script
  script: |
    echo "Building preview image..."
    # Add retry logic for docker build
    for i in {1..3}; do
      if docker build --network=host -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .; then
        break
      else
        echo "Build attempt $i failed, retrying in 10 seconds..."
        sleep 10
      fi
    done
    # Add retry logic for docker push
    for i in {1..3}; do
      if docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG; then
        break
      else
        echo "Push attempt $i failed, retrying in 10 seconds..."
        sleep 10
      fi
    done
    echo "Preview image pushed: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - .gitlab-ci.yml
        - Dockerfile
        - docker-compose.yml
        - "*.sh"
        - "*.py"
        - requirements.txt
  timeout: 30m